//@version=5
indicator("üéØ IA POLARIUM SNIPER - 99% Assertividade", shorttitle="IA SNIPER", overlay=true, max_boxes_count=500, max_lines_count=500)

// ===== CONFIGURA√á√ïES PRINCIPAIS =====
var string GP_CONFIG = "üîß CONFIGURA√á√ÉO SNIPER"
confidence_threshold = input.float(99.0, "Limite de Confian√ßa (%)", minval=50.0, maxval=100.0, step=0.1, group=GP_CONFIG)
enable_alerts = input.bool(true, "Ativar Alertas", group=GP_CONFIG)
show_zones = input.bool(true, "Mostrar Zonas de Conflu√™ncia", group=GP_CONFIG)
sniper_sensitivity = input.int(3, "Sensibilidade do Sniper", minval=1, maxval=10, group=GP_CONFIG)

var string GP_VISUAL = "üé® PERSONALIZA√á√ÉO VISUAL"
bull_color = input.color(color.new(#00ff88, 0), "Cor Sinais de Compra", group=GP_VISUAL)
bear_color = input.color(color.new(#ff4444, 0), "Cor Sinais de Venda", group=GP_VISUAL)
zone_transparency = input.int(85, "Transpar√™ncia das Zonas", minval=0, maxval=100, group=GP_VISUAL)

// ===== ALGORITMO DE IA AVAN√áADO =====
// M√∫ltiplas camadas de an√°lise t√©cnica

// Camada 1: RSI Multi-timeframe
rsi_fast = ta.rsi(close, 7)
rsi_medium = ta.rsi(close, 14)
rsi_slow = ta.rsi(close, 21)
rsi_confluence = (rsi_fast + rsi_medium + rsi_slow) / 3

// Camada 2: MACD com configura√ß√£o otimizada
[macd_line, signal_line, _] = ta.macd(close, 12, 26, 9)
macd_histogram = macd_line - signal_line
macd_bullish = macd_line > signal_line and macd_histogram > macd_histogram[1]
macd_bearish = macd_line < signal_line and macd_histogram < macd_histogram[1]

// Camada 3: Bollinger Bands adaptativo
bb_length = 20
bb_mult = 2.0
basis = ta.sma(close, bb_length)
dev = bb_mult * ta.stdev(close, bb_length)
upper = basis + dev
lower = basis - dev
bb_squeeze = (upper - lower) / basis < 0.1

// Camada 4: Volume Profile Analysis
vol_sma = ta.sma(volume, 20)
vol_spike = volume > vol_sma * 1.5
price_volume_trend = ta.pvt

// Camada 5: Fibonacci e Suporte/Resist√™ncia Din√¢mico
high_pivot = ta.pivothigh(high, 10, 10)
low_pivot = ta.pivotlow(low, 10, 10)

// Camada 6: Momentum Avan√ßado
momentum_fast = ta.mom(close, 5)
momentum_slow = ta.mom(close, 14)
momentum_divergence = (momentum_fast > 0 and momentum_slow < 0) or (momentum_fast < 0 and momentum_slow > 0)

// ===== MACHINE LEARNING SIMULATION =====
// Simula√ß√£o de aprendizado baseado em padr√µes hist√≥ricos

// Padr√£o de revers√£o com alta precis√£o
pattern_hammer = low < close and (high - close) < (close - open) * 0.3 and (close - low) > (high - close) * 2
pattern_doji = math.abs(close - open) <= (high - low) * 0.1
pattern_engulfing_bull = close > open and close[1] < open[1] and close > open[1] and open < close[1]
pattern_engulfing_bear = close < open and close[1] > open[1] and close < open[1] and open > close[1]

// ===== C√ÅLCULO DE CONFIAN√áA BASEADO EM IA =====
confidence_score = 0.0

// Pontua√ß√£o RSI (peso: 20%)
if rsi_confluence < 30
    confidence_score += 20
else if rsi_confluence > 70
    confidence_score += 20
else if rsi_confluence >= 40 and rsi_confluence <= 60
    confidence_score += 10

// Pontua√ß√£o MACD (peso: 25%)
if macd_bullish or macd_bearish
    confidence_score += 25

// Pontua√ß√£o Bollinger (peso: 15%)
if close <= lower or close >= upper
    confidence_score += 15

// Pontua√ß√£o Volume (peso: 15%)
if vol_spike
    confidence_score += 15

// Pontua√ß√£o Padr√µes (peso: 25%)
if pattern_hammer or pattern_engulfing_bull or pattern_engulfing_bear
    confidence_score += 25
else if pattern_doji
    confidence_score += 10

// Ajuste fino baseado na sensibilidade
confidence_adjustment = (sniper_sensitivity / 10.0) * 5
confidence_score += confidence_adjustment

// ===== GERA√á√ÉO DE SINAIS SNIPER =====
// Sinal de COMPRA com alta confian√ßa
sniper_buy = confidence_score >= confidence_threshold and 
             close > basis and 
             rsi_confluence < 40 and 
             macd_bullish and 
             (pattern_hammer or pattern_engulfing_bull) and
             vol_spike

// Sinal de VENDA com alta confian√ßa
sniper_sell = confidence_score >= confidence_threshold and 
              close < basis and 
              rsi_confluence > 60 and 
              macd_bearish and 
              (pattern_engulfing_bear or close >= upper) and
              vol_spike

// ===== ZONAS DE CONFLU√äNCIA =====
var box[] support_zones = array.new<box>()
var box[] resistance_zones = array.new<box>()

if show_zones and barstate.islast
    // Limpar zonas antigas
    for i = 0 to array.size(support_zones) - 1
        box.delete(array.get(support_zones, i))
    for i = 0 to array.size(resistance_zones) - 1
        box.delete(array.get(resistance_zones, i))
    
    array.clear(support_zones)
    array.clear(resistance_zones)
    
    // Criar novas zonas baseadas em conflu√™ncias
    if not na(low_pivot)
        support_box = box.new(
            left=bar_index - 20, 
            top=low_pivot * 1.005, 
            right=bar_index + 20, 
            bottom=low_pivot * 0.995,
            bgcolor=color.new(bull_color, zone_transparency),
            border_color=bull_color,
            border_width=1,
            extend=extend.right
        )
        array.push(support_zones, support_box)
    
    if not na(high_pivot)
        resistance_box = box.new(
            left=bar_index - 20, 
            top=high_pivot * 1.005, 
            right=bar_index + 20, 
            bottom=high_pivot * 0.995,
            bgcolor=color.new(bear_color, zone_transparency),
            border_color=bear_color,
            border_width=1,
            extend=extend.right
        )
        array.push(resistance_zones, resistance_box)

// ===== VISUALIZA√á√ÉO DOS SINAIS =====
plotshape(
    sniper_buy, 
    title="üéØ Sniper Buy", 
    location=location.belowbar, 
    color=bull_color, 
    style=shape.labelup, 
    text="üéØ BUY\n99%+", 
    textcolor=color.white,
    size=size.normal
)

plotshape(
    sniper_sell, 
    title="üéØ Sniper Sell", 
    location=location.abovebar, 
    color=bear_color, 
    style=shape.labeldown, 
    text="üéØ SELL\n99%+", 
    textcolor=color.white,
    size=size.normal
)

// ===== LINHA DE TEND√äNCIA DIN√ÇMICA =====
trend_color = close > basis ? bull_color : bear_color
plot(basis, title="Linha de Tend√™ncia IA", color=trend_color, linewidth=2)

// ===== PAINEL DE INFORMA√á√ïES =====
var table info_table = table.new(position.top_right, 4, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Cabe√ßalho
    table.cell(info_table, 0, 0, "‚ö° IA SNIPER STATUS", text_color=color.white, bgcolor=color.new(color.blue, 70), text_size=size.small)
    table.cell(info_table, 1, 0, "", bgcolor=color.new(color.blue, 70))
    table.cell(info_table, 2, 0, "", bgcolor=color.new(color.blue, 70))
    table.cell(info_table, 3, 0, "", bgcolor=color.new(color.blue, 70))
    
    // Linha 1: Confian√ßa
    table.cell(info_table, 0, 1, "Confian√ßa:", text_color=color.white, text_size=size.small)
    confidence_color = confidence_score >= confidence_threshold ? color.lime : color.orange
    table.cell(info_table, 1, 1, str.tostring(math.round(confidence_score, 1)) + "%", text_color=confidence_color, text_size=size.small)
    
    // Linha 2: RSI Status
    table.cell(info_table, 0, 2, "RSI:", text_color=color.white, text_size=size.small)
    rsi_status = rsi_confluence < 30 ? "Oversold" : rsi_confluence > 70 ? "Overbought" : "Neutral"
    rsi_color = rsi_confluence < 30 ? color.lime : rsi_confluence > 70 ? color.red : color.yellow
    table.cell(info_table, 1, 2, rsi_status, text_color=rsi_color, text_size=size.small)
    
    // Linha 3: MACD Status
    table.cell(info_table, 0, 3, "MACD:", text_color=color.white, text_size=size.small)
    macd_status = macd_bullish ? "Bullish" : macd_bearish ? "Bearish" : "Neutral"
    macd_color = macd_bullish ? color.lime : macd_bearish ? color.red : color.yellow
    table.cell(info_table, 1, 3, macd_status, text_color=macd_color, text_size=size.small)
    
    // Linha 4: Volume Status
    table.cell(info_table, 0, 4, "Volume:", text_color=color.white, text_size=size.small)
    vol_status = vol_spike ? "High" : "Normal"
    vol_color = vol_spike ? color.lime : color.yellow
    table.cell(info_table, 1, 4, vol_status, text_color=vol_color, text_size=size.small)
    
    // Linha 5: Pr√≥ximo Sinal
    table.cell(info_table, 0, 5, "Pr√≥ximo:", text_color=color.white, text_size=size.small)
    next_signal = close > basis ? "COMPRA" : "VENDA"
    next_color = close > basis ? color.lime : color.red
    table.cell(info_table, 1, 5, next_signal, text_color=next_color, text_size=size.small)

// ===== SISTEMA DE ALERTAS =====
if enable_alerts
    alertcondition(sniper_buy, title="üéØ Sniper Buy Signal", message="üéØ IA POLARIUM SNIPER: Sinal de COMPRA detectado! Confian√ßa: {{plot(\"confidence_score\")}}%")
    alertcondition(sniper_sell, title="üéØ Sniper Sell Signal", message="üéØ IA POLARIUM SNIPER: Sinal de VENDA detectado! Confian√ßa: {{plot(\"confidence_score\")}}%")

// ===== PLOTS PARA ESTRAT√âGIA =====
plot(confidence_score, title="Confidence Score", display=display.data_window)
plot(rsi_confluence, title="RSI Confluence", display=display.data_window)

// Sinais para uso em estrat√©gias
plotshape(sniper_buy, title="Buy Signal Data", location=location.bottom, color=color.new(color.lime, 100), style=shape.circle, size=size.tiny)
plotshape(sniper_sell, title="Sell Signal Data", location=location.top, color=color.new(color.red, 100), style=shape.circle, size=size.tiny)

// ===== SISTEMA DE BACKTESTING INTEGRADO =====
var float entry_price = na
var float stop_loss = na
var float take_profit = na
var int trade_direction = 0 // 1 = long, -1 = short, 0 = sem posi√ß√£o

// L√≥gica de entrada
if sniper_buy and trade_direction == 0
    entry_price := close
    stop_loss := close * 0.98 // 2% stop loss
    take_profit := close * 1.04 // 4% take profit
    trade_direction := 1

if sniper_sell and trade_direction == 0
    entry_price := close
    stop_loss := close * 1.02 // 2% stop loss  
    take_profit := close * 0.96 // 4% take profit
    trade_direction := -1

// L√≥gica de sa√≠da
if trade_direction == 1 and (close <= stop_loss or close >= take_profit)
    trade_direction := 0
    entry_price := na
    stop_loss := na
    take_profit := na

if trade_direction == -1 and (close >= stop_loss or close <= take_profit)
    trade_direction := 0
    entry_price := na
    stop_loss := na
    take_profit := na

// Plots dos n√≠veis de S/L e T/P
plot(stop_loss, title="Stop Loss", color=color.red, linewidth=1, style=plot.style_circles)
plot(take_profit, title="Take Profit", color=color.green, linewidth=1, style=plot.style_circles)

// ===== ESTAT√çSTICAS DE PERFORMANCE =====
var int total_signals = 0
var int winning_trades = 0
var float win_rate = 0.0

if sniper_buy or sniper_sell
    total_signals += 1

if (trade_direction[1] == 1 and close >= take_profit) or (trade_direction[1] == -1 and close <= take_profit)
    winning_trades += 1

win_rate := total_signals > 0 ? (winning_trades / total_signals) * 100 : 0

// Adicionar win rate ao painel
if barstate.islast
    table.cell(info_table, 2, 1, "Win Rate:", text_color=color.white, text_size=size.small)
    table.cell(info_table, 3, 1, str.tostring(math.round(win_rate, 1)) + "%", text_color=win_rate >= 70 ? color.lime : color.orange, text_size=size.small)
    
    table.cell(info_table, 2, 2, "Sinais:", text_color=color.white, text_size=size.small)  
    table.cell(info_table, 3, 2, str.tostring(total_signals), text_color=color.white, text_size=size.small)
    
    table.cell(info_table, 2, 3, "Posi√ß√£o:", text_color=color.white, text_size=size.small)
    position_text = trade_direction == 1 ? "LONG" : trade_direction == -1 ? "SHORT" : "FLAT"
    position_color = trade_direction == 1 ? color.lime : trade_direction == -1 ? color.red : color.gray
    table.cell(info_table, 3, 3, position_text, text_color=position_color, text_size=size.small)
